<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Strategy Steps</title>

<style>
body {
  font-family: sans-serif;
  background: #f2f2f2;
  display: flex;
}

#stairsWrapper {
  position: relative;
  margin: 20px;
}

.step {
  width: 200px;
  height: 30px;
  border: 1px solid #aaa;
  background: #fff;
  box-sizing: border-box;
  font-size: 12px;
  padding-left: 5px;
}

.marker {
  position: absolute;
  width: 22px;
  height: 22px;
  border-radius: 50%;
  color: #fff;
  font-size: 12px;
  text-align: center;
  line-height: 22px;
  transition: top 0.5s ease;
}

.p1 { background: red;    left: 10px; }
.p2 { background: blue;   left: 55px; }
.p3 { background: green;  left: 100px;}
.p4 { background: purple; left: 145px; }

/* ---------- 中央 ---------- */
#game {
  margin: 20px;
  width: 220px;
}

.choiceButtons button {
  font-size: 20px;
  width: 60px;
  height: 60px;
  margin: 5px;
  cursor: pointer;
}

#log {
  margin-top: 15px;
  font-size: 16px;
}

#choices {
  margin: 20px;
  width: 240px;
}

.choiceBox {
  background: #fff;
  border-radius: 8px;
  padding: 10px;
  margin-bottom: 10px;
  font-size: 18px;
}

.num {
  font-size: 36px;
  font-weight: bold;
}

.c1 { color: red; }
.c2 { color: blue; }
.c3 { color: green; }
.c4 { color: purple; }

.rank {
  background: #fff;
  padding: 10px;
  border-radius: 8px;
  margin-top: 10px;
}
</style>
</head>
<body>

<div id="stairsWrapper">
  <div id="stairs"></div>
  <div class="marker p1" id="m1">1</div>
  <div class="marker p2" id="m2">2</div>
  <div class="marker p3" id="m3">3</div>
  <div class="marker p4" id="m4">4</div>
</div>

<div id="game">
  <h2></h2>
  <div class="choiceButtons">
    <button onclick="play(1)">1</button>
    <button onclick="play(3)">3</button>
    <button onclick="play(5)">5</button>
  </div>
  <div id="log"></div>
</div>

<div id="choices">
  <h2></h2>
  <div class="choiceBox c1">P1：<span id="c1" class="num">-</span></div>
  <div class="choiceBox c2">CPU2：<span id="c2" class="num">-</span></div>
  <div class="choiceBox c3">CPU3：<span id="c3" class="num">-</span></div>
  <div class="choiceBox c4">CPU4：<span id="c4" class="num">-</span></div>
  <div id="ranking"></div>
</div>

<script>
const GOAL = 12;
const STEP_HEIGHT = 30;

let pos = [0, 0, 0, 0];
let finished = false;

function initStairs() {
  const s = document.getElementById("stairs");
  for (let i = GOAL; i >= 0; i--) {
    const step = document.createElement("div");
    step.className = "step";
    step.textContent = i;
    s.appendChild(step);
  }
}

function updateMarkers() {
  pos.forEach((p, i) => {
    const marker = document.getElementById(`m${i+1}`);
    marker.style.top = `${(GOAL - p) * STEP_HEIGHT + 4}px`;
  });
}

initStairs();
updateMarkers();

function cpuChoice() {
  return [1,3,5][Math.floor(Math.random() * 3)];
}

function play(playerValue) {
  if (finished) return;

  const choices = [
    playerValue,
    cpuChoice(),
    cpuChoice(),
    cpuChoice()
  ];

  choices.forEach((v, i) => {
    document.getElementById(`c${i+1}`).textContent = v;
  });

  const count = {};
  choices.forEach(v => count[v] = (count[v] || 0) + 1);

  let moved = [];

  for (let i = 0; i < 4; i++) {
    if (count[choices[i]] === 1) {
      pos[i] += choices[i];
      if (pos[i] > GOAL) pos[i] = GOAL;
      moved.push(`P${i+1}`);
    }
  }

  updateMarkers();

  document.getElementById("log").innerHTML =
    `${choices.join(" , ")}<br>` +
    (moved.length ? `進んだ：${moved.join(", ")}` : "進めない");

  if (pos.some(p => p >= GOAL)) {
    finished = true;
    showRanking();
  }
}

function showRanking() {
  const players = [
    { id: 1, score: pos[0] },
    { id: 2, score: pos[1] },
    { id: 3, score: pos[2] },
    { id: 4, score: pos[3] }
  ];

  players.sort((a, b) => b.score - a.score);

  let rank = 1;
  let prevScore = null;

  let html = `<div class="rank"><b>決着！順位</b><br>`;

  players.forEach((p, i) => {
    if (prevScore !== null && p.score < prevScore) {
      rank = i + 1;
    }
    html += `${rank}位：プレイヤー${p.id}（${p.score}段）<br>`;
    prevScore = p.score;
  });

  html += `</div>`;
  document.getElementById("ranking").innerHTML = html;
}
</script>

</body>
</html>
